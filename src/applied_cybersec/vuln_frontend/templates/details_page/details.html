{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}Details{% endblock title %}

{% block content %}

<div style="padding-top: 20px;">
    <h1>
        {{repo.name}}
    </h1>
</div>

<!-- chart.js include -->

<div class="jumbotron" style="margin-top: 10px;">
    <canvas id="myChart" width="1000" height="400"></canvas>
</div>

<script>
var ctx = document.getElementById("myChart").getContext("2d");

const colors = {
  cvss_low: {
    fill: '#ffe564',
    stroke: '#ffe564'
  },
  cvss_medium: {
    fill: '#ffbc64',
    stroke: '#ffbc64',
  },
  cvss_high: {
    fill: '#ff8f64',
    stroke: '#ff8f64',
  },
  cvss_critical: {
    fill: '#ff6464',
    stroke: '#ff6464',
  },
};

const number_vuln_critical = {{ graph_data|get_item:"critical" }};
const numbber_vuln_high = {{ graph_data|get_item:"high" }};
const number_vuln_medium = {{ graph_data|get_item:"medium" }};
const number_vuln_low = {{ graph_data|get_item:"low" }};
var created_at = {{ graph_data|get_item:"created_at"|safe }};

// change to type date:
for (var i = 0; i < created_at.length; i++) {
  created_at[i] = new Date(created_at[i]);
}

const myChart = new Chart(ctx, {
  type: 'line',
  data: {
    labels: created_at,
    datasets: [{
      label: "Low",
      fill: true,
      backgroundColor: 'rgba(255, 229, 100, 0.8)',
      pointBackgroundColor: 'rgba(255, 229, 100, 0.8)',
      borderColor:'rgba(255, 229, 100, 1)',
      pointHighlightStroke: 'rgba(255, 229, 100, 1)',
      borderCapStyle: 'butt',
      data: number_vuln_low,

    }, {
      label: "Medium",
      fill: true,
      backgroundColor: 'rgba(255, 188, 100, 0.6)',
      pointBackgroundColor: 'rgba(255, 188, 100, 0.6)',
      borderColor:'rgba(255, 188, 100, 1)',
      pointHighlightStroke: 'rgba(255, 188, 100, 1)',
      borderCapStyle: 'butt',
      data: number_vuln_medium,
    }, {
      label: "High",
      fill: true,
      backgroundColor: 'rgba(255, 143, 100, 0.4)',
      pointBackgroundColor: 'rgba(255, 143, 100, 0.4)',
      borderColor:'rgba(255, 143, 100, 1)',
      pointHighlightStroke: 'rgba(255, 143, 100, 1)',
      borderCapStyle: 'butt',
      data: numbber_vuln_high,
    }, {
      label: "Critical",
      fill: true,
      backgroundColor: 'rgba(255, 100, 100, 0.2)',
      pointBackgroundColor: 'rgba(255, 100, 100, 0.2)',
      borderColor:'rgba(255, 100, 100, 1)',
      pointHighlightStroke: 'rgba(255, 100, 100, 1)',
      data: number_vuln_critical,
    }]
  },
  options: {
    // Can't just `stacked: true` like the docs say
    scales: {
        x: {
        title: {
          display: true,
          text: 'Date of Scan'
        },
        type: 'time',
        time: {
          unit: 'day',
        }
      },
      y: {
        min: 0,
        stacked: true,
        title: {
          display: true,
          text: 'Vulnerabilities'
        }
      }
    },
    animation: {
      duration: 750,
    },
    plugins: {
      legend: {
        position: 'bottom'
      }
    }
  }
});
</script>

    {% comment %} Display Details Data {% endcomment %}
    <div class="row">
        <div class="jumbotron col-md-6">
            Repository Data:
            <p>ID: {{ repo.id }}</p>
            <p>Name: {{ repo.name }}</p>
            <p>Organisation: {{ repo.org }}</p>
            <p>URL: {{ repo.url }} </p>
        </div>
        <div class="jumbotron col-md-6">
            Scan Data:
            <p>ID: {{ selected_scan|get_item:"scan"|get_item:"id" }}</p>
            <p>Created At: {{ selected_scan|get_item:"scan"|get_item:"created_at" }}</p>
            <p>Workflow ID: {{ selected_scan|get_item:"scan"|get_item:"workflow_id" }}</p>
            <p>#Dependencies: {{ selected_scan|get_item:"statistics"|get_item:"number_dependencies" }}</p>
            <p>#Vulns: {{ selected_scan|get_item:"statistics"|get_item:"number_vulnerabilities" }}</p>
            <p>#Critical: {{ selected_scan|get_item:"statistics"|get_item:"number_vuln_critical" }}</p>
            <p>#High: {{ selected_scan|get_item:"statistics"|get_item:"number_vuln_high" }}</p>
            <p>#Medium: {{ selected_scan|get_item:"statistics"|get_item:"number_vuln_medium" }}</p>
            <p>#Low: {{ selected_scan|get_item:"statistics"|get_item:"number_vuln_low" }}</p>
        </div>
    </div>

    <br>
    <br>
    <button onclick="select_scan('{{repo.organization}}','{{repo.name}}');">Test</button>
    <br>
    <form>
        <div class="row form-group">
            <div class="col-sm-4">
                <div class="input-group date" id="datepicker">
                    <input type="text" class="form-control">
                    <span class="input-group-append">
                        <span class="input-group-text bg-white">
                            <i class="fa fa-calendar"></i>
                        </span>
                    </span>
                </div>
            </div>
        </div>
    </form>

    <script type="text/javascript">
        $(function() {
            $('#datepicker').datepicker();
        });
    </script>
    <br>
    <div id="pagination_div">
        {% for page_number in vuln_page_obj.adjusted_elided_pages  %}
            {% if page_number == page_obj.paginator.ELLIPSIS %}
                {{page_number}}
            {% else %}
                <a
                    id="pagination_link_{{page_number}}"
                    href="/details/{{repo.organization}}/{{repo.name}}?page={{page_number}}"
                    data-repo-org="{{repo.organization}}"
                    data-repo-name="{{repo.name}}"
                    data-page-number="{{page_number}}"
                    class="{% if page_number == page_obj.number %}current{% endif %}"
                >
                    {{page_number}}
                </a>
            {% endif %}
        {% endfor %}
    </div>

    {% comment %} Vulnerability Table {% endcomment %}
    <div class="table-responsive">
        <table class="table table-hover table-striped">
            <thead>
                <tr class="head_row">
                    <th style="width:25%;">Vulnerabbility ID</th>
                    <th style="width:35%;">Severity</th>
                    <th style="width:18%;text-align:center;">CVSS</th>
                    {% comment %} <th style="width:22%;text-align:center;">{% trans "Testdatum" %}</th> {% endcomment %}
                </tr>
            </thead>
            <tbody id='vuln_table_body'>
                {% for vuln in vuln_page_obj %}
                <tr style="transform: rotate(0);">
                    <td scope="row">
                        {{ vuln.vuln_id }}
                        {% comment %} <a style="text-decoration:none;color:inherit;" href="test/{{test.uuid}}" class="stretched-link"></a>                         {% endcomment %}
                    </td>
                    <td>
                        {{ vuln.severity}}
                    </td>
                    <td style="text-align:center;">
                        {% if vuln.cvss|length > 0 %}
                            {{ vuln.cvss.0|get_item:"metrics"|get_item:"baseScore" }} (Version 2) </br>
                        {% endif %}
                        {% if vuln.cvss|length > 1 %}
                            {{ vuln.cvss.1|get_item:"metrics"|get_item:"baseScore" }} (Version 3)
                        {% endif %}
                    </td>
                    {% comment %} <td style="text-align:center;">
                        {% if test.resultDate %}{{test.resultDate}}{% else %}{% trans "Datum ausstehend" %}{% endif %}
                    </td> {% endcomment %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock content %}


{% block statics %}
    <script src="{% static 'js/details_ajax.js' %}" type="text/javascript"></script>
{% endblock %}